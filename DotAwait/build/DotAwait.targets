<Project>

  <PropertyGroup>
    <DotAwaitTasksDir>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)..\bin\$(Configuration)\netstandard2.0\'))</DotAwaitTasksDir>
    <DotAwaitDll>$(DotAwaitTasksDir)DotAwait.dll</DotAwaitDll>
    <DotAwaitIntermediateDir>$(IntermediateOutputPath)dotawait\</DotAwaitIntermediateDir>
    <DotAwaitOut>$(DotAwaitIntermediateDir)src\</DotAwaitOut>

    <!-- Make sure rewritten sources are never picked up by wildcards (esp. in design-time) -->
    <DefaultItemExcludes>$(DefaultItemExcludes);$(DotAwaitIntermediateDir)**\*.cs</DefaultItemExcludes>
  </PropertyGroup>

  <UsingTask TaskName="DotAwait.RewriteSourcesTask"
             AssemblyFile="$(DotAwaitDll)"
             Condition="Exists('$(DotAwaitDll)')"
             TaskFactory="TaskHostFactory" />

  <!-- Delete DotAwait intermediate outputs on Clean (Project > Clean / dotnet clean) -->
  <Target Name="DotAwait_Clean"
          AfterTargets="Clean"
          Condition="Exists('$(DotAwaitIntermediateDir)')">

    <RemoveDir Directories="$(DotAwaitIntermediateDir)" />

  </Target>

  <!-- Build-time only: do NOT affect IntelliSense / design-time compilation -->
  <Target Name="DotAwait_Rewrite"
          BeforeTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(DotAwaitActive)' != 'true' and Exists('$(DotAwaitDll)')">

    <PropertyGroup>
      <DotAwaitActive>true</DotAwaitActive>
    </PropertyGroup>

    <ItemGroup>
      <_DotAwaitOriginalCompile Include="@(Compile)" />
      <_DotAwaitReferencePath Include="@(ReferencePath)" />
    </ItemGroup>

    <RewriteSourcesTask
        Sources="@(_DotAwaitOriginalCompile)"
        ProjectDirectory="$(MSBuildProjectDirectory)"
        OutputDirectory="$(DotAwaitOut)"
        DefineConstants="$(DefineConstants)"
        LangVersion="$(LangVersion)"
        ReferencePaths="@(_DotAwaitReferencePath)">
      <Output TaskParameter="RewrittenSources" ItemName="_DotAwaitRewritten" />
    </RewriteSourcesTask>

    <!-- Construct the compile list for CoreCompile and dedupe by path -->
    <ItemGroup>
      <_DotAwaitFinal Include="@(_DotAwaitKeep->'%(FullPath)')" />
      <_DotAwaitFinal Include="@(_DotAwaitRewritten->'%(FullPath)')" />
    </ItemGroup>

    <RemoveDuplicates Inputs="@(_DotAwaitFinal)">
      <Output TaskParameter="Filtered" ItemName="_DotAwaitFinalDistinct" />
    </RemoveDuplicates>

    <ItemGroup>
      <Compile Remove="@(Compile)" />
      <Compile Include="@(_DotAwaitFinalDistinct)" />
    </ItemGroup>

  </Target>

  <!-- Restore original Compile items right after compiler run -->
  <Target Name="DotAwait_Restore"
          AfterTargets="CoreCompile"
          Condition="'$(DesignTimeBuild)' != 'true' and '$(DotAwaitActive)' == 'true' and Exists('$(DotAwaitDll)')">

    <ItemGroup>
      <Compile Remove="@(Compile)" />
      <Compile Include="@(_DotAwaitOriginalCompile)" />
    </ItemGroup>

    <PropertyGroup>
      <DotAwaitActive>false</DotAwaitActive>
    </PropertyGroup>

  </Target>

</Project>
