<Project>
  <UsingTask AssemblyFile="$(MSBuildThisFileDirectory)..\DotAwait\bin\Debug\netstandard2.0\DotAwait.dll"
             TaskName="RewriteSourcesTask" />

  <PropertyGroup>
    <RewrittenDir>$(BaseIntermediateOutputPath)$(Configuration)\$(TargetFramework)\Rewritten</RewrittenDir>
  </PropertyGroup>

  <!-- Ð”Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ñ‚Ð°ÑÐºÑƒ Ð² Ñ†ÐµÐ¿Ð¾Ñ‡ÐºÑƒ CoreCompile -->
  <PropertyGroup>
    <CoreCompileDependsOn>
      RewriteSources;
      $(CoreCompileDependsOn)
    </CoreCompileDependsOn>
  </PropertyGroup>

  <Target Name="RewriteSources"
          Inputs="@(Compile)"
          Outputs="$(RewrittenDir)\_done.flag">

    <MakeDir Directories="$(RewrittenDir)" />

    <RewriteSourcesTask Compile="@(Compile)"
                        OutputDirectory="$(RewrittenDir)"
                        ProjectPath="$(MSBuildProjectFullPath)">
      <Output TaskParameter="RewrittenFiles" ItemName="RewrittenCompile" />
    </RewriteSourcesTask>

    <ItemGroup>
      <_OriginalCompile Include="@(Compile)" />
      <Compile Remove="@(Compile)" />
      <Compile Include="@(RewrittenCompile)" />
    </ItemGroup>

    <!-- (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ð¾Ñ€Ð¸Ð³Ð¸Ð½Ð°Ð»Ñ‹ ÐºÐ°Ðº None, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ñ€Ð¾Ð¿Ð°Ð´Ð°Ð»Ð¸ Ð¸Ð· IDE -->
    <ItemGroup>
      <None Include="@(_OriginalCompile)" Condition="'$(BuildingInsideVisualStudio)' == 'true'" />
    </ItemGroup>

    <WriteLinesToFile File="$(RewrittenDir)\_done.flag" Lines="done" />
  </Target>

  <!-- Ð”Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ Ð¿Ñ€Ð¸ Clean -->
  <Target Name="CleanRewritten" AfterTargets="Clean">
    <Message Text="ðŸ§¹ Post-Clean: deleting $(RewrittenDir)" Importance="High" />
    <RemoveDir Directories="$(RewrittenDir)" />
  </Target>
</Project>
